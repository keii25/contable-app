
import { useSelector } from 'react-redux';
import { useMemo, useState } from 'react';
import { selectTransacciones } from '../store/selectors';
import type { Transaccion } from '../types';

function polarToCartesian(cx:number, cy:number, r:number, angle:number){ return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) }; }
function ymFromDateStr(d: string) { return d.slice(0,7); }
const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
function groupByCuenta(list: Transaccion[]) { const map = new Map<string, { total: number; count: number }>(); for (const t of list) { const key = t.cuentaContable; const prev = map.get(key) || { total: 0, count: 0 }; prev.total += t.valor; prev.count += 1; map.set(key, prev); } return Array.from(map.entries()).map(([cuenta, v]) => ({ cuenta, total: v.total, count: v.count })).sort((a,b)=> b.total - a.total); }

function Pie({ ingresos, egresos }:{ ingresos:number; egresos:number }){ const total = Math.max(ingresos + egresos, 1); const incPct = ingresos/total; const egPct = egresos/total; const radius = 70; const cx = 90; const cy = 90; const full = 2*Math.PI; const incAngle = full*incPct; const egAngle = full*egPct; const incMid = incAngle/2; const egMid = incAngle + egAngle/2; const incLabel = `${(incPct*100).toFixed(0)}%`; const egLabel = `${(egPct*100).toFixed(0)}%`; const iLab = polarToCartesian(cx, cy, radius*0.58, incMid); const eLab = polarToCartesian(cx, cy, radius*0.58, egMid); const slice=(start:number,end:number,color:string)=>{ const p1=polarToCartesian(cx,cy,radius,start); const p2=polarToCartesian(cx,cy,radius,end); const largeArc=end-start>Math.PI?1:0; const d=`M ${cx} ${cy} L ${p1.x} ${p1.y} A ${radius} ${radius} 0 ${largeArc} 1 ${p2.x} ${p2.y} Z`; return <path d={d} fill={color} filter='url(#shadow)'/>; }; return (<div className='card' style={{display:'grid', gridTemplateColumns:'200px 1fr', gap:16}}><svg width={220} height={200} viewBox='0 0 220 200'><defs><filter id='shadow' x='-50%' y='-50%' width='200%' height='200%'><feDropShadow dx='0' dy='2' stdDeviation='2' floodColor='#000' floodOpacity='0.15'/></filter></defs><circle cx={cx} cy={cy} r={radius} fill='#f3f4f6'/>{incPct>0&&slice(0,incAngle,'#10b981')}{egPct>0&&slice(incAngle,incAngle+egAngle,'#ef4444')}{incPct>0&&<text x={iLab.x} y={iLab.y} fontSize={12} textAnchor='middle' fill='#065f46'>{incLabel}</text>}{egPct>0&&<text x={eLab.x} y={eLab.y} fontSize={12} textAnchor='middle' fill='#7f1d1d'>{egLabel}</text>}</svg><div><div className='hdr'>Ingresos vs Egresos</div><p><span className='legend-dot' style={{background:'#10b981'}}></span>Ingresos: ${ingresos.toLocaleString()}</p><p><span className='legend-dot' style={{background:'#ef4444'}}></span>Egresos: ${egresos.toLocaleString()}</p><p className='sub'>Las etiquetas muestran el porcentaje relativo de cada segmento.</p></div></div>); }

export default function Dashboard(){ const items = useSelector(selectTransacciones); const [scope,setScope]=useState<'GENERAL'|'MENSUAL'>('GENERAL'); const anios = Array.from(new Set(items.map(t=>t.fecha.slice(0,4)))).sort(); const [anioSel,setAnioSel]=useState<string>(anios[0]||new Date().getFullYear().toString()); const [mesSel,setMesSel]=useState<number>(new Date().getMonth()); const { listFiltrada, ingresosTotal, egresosTotal, titulo } = useMemo(()=>{ if(scope==='GENERAL'){ const ingresosTotal = items.filter(t=>t.tipoMovimiento==='CREDITO').reduce((a,b)=>a+b.valor,0); const egresosTotal = items.filter(t=>t.tipoMovimiento==='DEBITO').reduce((a,b)=>a+b.valor,0); return { listFiltrada: items, ingresosTotal, egresosTotal, titulo:'General' }; } else { const mm=String(mesSel+1).padStart(2,'0'); const ym=`${anioSel}-${mm}`; const list = items.filter(t=> ymFromDateStr(t.fecha)===ym); const ingresosTotal=list.filter(t=>t.tipoMovimiento==='CREDITO').reduce((a,b)=>a+b.valor,0); const egresosTotal=list.filter(t=>t.tipoMovimiento==='DEBITO').reduce((a,b)=>a+b.valor,0); return { listFiltrada:list, ingresosTotal, egresosTotal, titulo:`${MESES[mesSel]} ${anioSel}` }; } }, [items, scope, anioSel, mesSel]); const saldo = ingresosTotal - egresosTotal; const saldoClass = saldo<0? 'kpi kpi-red' : 'kpi kpi-green'; const { subIngresos, subEgresos } = useMemo(()=>{ const ingresosList = listFiltrada.filter(t=>t.tipoMovimiento==='CREDITO'); const egresosList = listFiltrada.filter(t=>t.tipoMovimiento==='DEBITO'); return { subIngresos: groupByCuenta(ingresosList), subEgresos: groupByCuenta(egresosList) }; }, [listFiltrada]); return (<div className='container'><div className='grid' style={{gap:16}}><div className='card'><div className='flex' style={{gap:8, alignItems:'center'}}><label><strong>Filtro:</strong></label>{/* ← Ámbito -> Filtro */}<select className='select' value={scope} onChange={e=>setScope(e.target.value as any)}><option value='GENERAL'>General</option><option value='MENSUAL'>Por Mes y Año</option></select>{scope==='MENSUAL' && (<><label>Año:</label><select className='select' value={anioSel} onChange={e=>setAnioSel(e.target.value)}>{anios.map(a=> <option key={a} value={a}>{a}</option>)}</select><label>Mes:</label><select className='select' value={mesSel} onChange={e=>setMesSel(Number(e.target.value))}>{MESES.map((m,i)=> <option key={m} value={i}>{m}</option>)}</select></>)} </div></div><div className='card'><div className='hdr'>Saldo Neto — {titulo}</div><div className={saldoClass}>${saldo.toLocaleString()}</div></div><div className='card'><div className='hdr'>Ingresos — {titulo}</div><div className='kpi kpi-green'>${ingresosTotal.toLocaleString()}</div></div><div className='card'><div className='hdr'>Egresos — {titulo}</div><div className='kpi kpi-red'>${egresosTotal.toLocaleString()}</div></div><Pie ingresos={ingresosTotal} egresos={egresosTotal}/><div className='card' style={{marginTop:12}}><div className='hdr'>Ingresos — Subconceptos</div><div style={{overflowX:'auto'}}><table className='table'><thead><tr><th>Subconcepto (Cuenta)</th><th style={{textAlign:'right'}}>Total</th></tr></thead><tbody>{subIngresos.map(s=> (<tr key={s.cuenta}><td>{s.cuenta}</td><td style={{textAlign:'right'}}>${s.total.toLocaleString()}</td></tr>))}{subIngresos.length===0 && (<tr><td colSpan={2} className='sub'>Sin registros de ingresos en el período seleccionado.</td></tr>)} </tbody></table></div></div><div className='card' style={{marginTop:12}}><div className='hdr'>Egresos — Subconceptos</div><div style={{overflowX:'auto'}}><table className='table'><thead><tr><th>Subconcepto (Cuenta)</th><th style={{textAlign:'right'}}>Total</th></tr></thead><tbody>{subEgresos.map(s=> (<tr key={s.cuenta}><td>{s.cuenta}</td><td style={{textAlign:'right'}}>${s.total.toLocaleString()}</td></tr>))}{subEgresos.length===0 && (<tr><td colSpan={2} className='sub'>Sin registros de egresos en el período seleccionado.</td></tr>)} </tbody></table></div></div></div></div>); }
